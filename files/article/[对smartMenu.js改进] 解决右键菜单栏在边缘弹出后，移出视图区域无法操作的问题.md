{"title":"【博客园富文本 to Markdown】[对smartMenu.js改进] 解决右键菜单栏在边缘弹出后，移出视图区域无法操作的问题","content":"当用户在视图边缘（如右下角）右键召唤菜单栏的时候，菜单仍然从选中元素的右下角弹出，这时二级菜单栏一般都离开了视图区域，用户无法进一步操作。\n\n这个问题挺常见的，原作者的留言板：\n![](https://images2017.cnblogs.com/blog/1182173/201712/1182173-20171204172224810-1171876778.png)\n![](https://images2017.cnblogs.com/blog/1182173/201712/1182173-20171204172138716-2065474607.png)\n\n\n\n\n 但是作者应该是已经不再维护了，最后一个版本还是2011年10月的。\n\n我给出的比较初步的解决方案：\n\n因为作者没有给出鼠标事件的接口，只能在库的源码中修改坐标计算逻辑，以达到根据位置自适应弹出菜单的目的。\n\n思路：判断右键点击位置，与窗口（我的是iframe窗口）大小作比较，取中心点分为坐标系的四个象限。\n\n　　1、在第一象限召唤菜单栏，显示在触发事件元素的左下角\n\n　　2、在第二象限召唤菜单栏，显示在触发事件元素的左上角\n\n　　3、在第三象限召唤菜单栏，显示在触发事件元素的右上角\n\n　　4、在第四象限召唤菜单栏，显示在触发事件元素的右下角\n\n完整的代码如下：\n\n```\n/*\n * smartMenu.js 智能上下文菜单插件\n * http://www.zhangxinxu.com/\n *\n * Copyright 2011, zhangxinxu\n *\n * 2011-05-26 v1.0    编写\n * 2011-06-03 v1.1    修复func中this失准问题\n * 2011-10-10 v1.2  修复脚本放在<head>标签中层无法隐藏的问题\n * 2011-10-30 v1.3  修复IE6~7下二级菜单移到第二项隐藏的问题\n */\n \n(function($) {\n    var D = $(document).data(\"func\", {});    \n    $.smartMenu = $.noop;\n    $.fn.smartMenu = function(data, options) {\n        var B = $(\"body\"), defaults = {\n            name: \"\",\n            offsetX: 2,\n            offsetY: 2,\n            textLimit: 6,\n            beforeShow: $.noop,\n            afterShow: $.noop\n        };\n        var params = $.extend(defaults, options || {});\n        \n        var htmlCreateMenu = function(datum) {\n            var dataMenu = datum || data, nameMenu = datum? Math.random().toString(): params.name, htmlMenu = \"\", htmlCorner = \"\", clKey = \"smart_menu_\";\n            if ($.isArray(dataMenu) && dataMenu.length) {\n                htmlMenu = '<div id=\"smartMenu_'+ nameMenu +'\" class=\"'+ clKey +'box\">' +\n                                '<div class=\"'+ clKey +'body\">' +\n                                    '<ul class=\"'+ clKey +'ul\">';\n                                    \n                $.each(dataMenu, function(i, arr) {\n                    if (i) {\n                        htmlMenu = htmlMenu + '<li class=\"'+ clKey +'li_separate\">&nbsp;</li>';    \n                    }\n                    if ($.isArray(arr)) {\n                        $.each(arr, function(j, obj) {\n                            var text = obj.text, htmlMenuLi = \"\", strTitle = \"\", rand = Math.random().toString().replace(\".\", \"\");\n                            if (text) {\n                                if (text.length > params.textLimit) {\n                                    text = text.slice(0, params.textLimit)    + \"…\";\n                                    strTitle = ' title=\"'+ obj.text +'\"';\n                                }\n                                if ($.isArray(obj.data) && obj.data.length) {\n                                    htmlMenuLi = '<li class=\"'+ clKey +'li\" data-hover=\"true\">' + htmlCreateMenu(obj.data) +\n                                        '<a href=\"javascript:\" class=\"'+ clKey +'a\"'+ strTitle +' data-key=\"'+ rand +'\"><i class=\"'+ clKey +'triangle\"></i>'+ text +'</a>' + \n                                    '</li>';\n                                } else {\n                                    htmlMenuLi = '<li class=\"'+ clKey +'li\">' +\n                                        '<a href=\"javascript:\" class=\"'+ clKey +'a\"'+ strTitle +' data-key=\"'+ rand +'\">'+ text +'</a>' + \n                                    '</li>';\n                                }\n                                \n                                htmlMenu += htmlMenuLi;\n                                \n                                var objFunc = D.data(\"func\");\n                                objFunc[rand] = obj.func;\n                                D.data(\"func\", objFunc);\n                            }\n                        });    \n                    }\n                });\n                \n                htmlMenu = htmlMenu + '</ul>' +\n                                    '</div>' +\n                                '</div>';\n            }\n            return htmlMenu;\n        }, funSmartMenu = function() {\n            var idKey = \"#smartMenu_\", clKey = \"smart_menu_\", jqueryMenu = $(idKey + params.name);\n            if (!jqueryMenu.size()) {\n                $(\"body\").append(htmlCreateMenu());\n                \n                //事件\n                $(idKey + params.name +\" a\").bind(\"click\", function() {\n                    var key = $(this).attr(\"data-key\"),\n                        callback = D.data(\"func\")[key];\n                    if ($.isFunction(callback)) {\n                        callback.call(D.data(\"trigger\"));    \n                    }\n                    $.smartMenu.hide();\n                    return false;\n                });\n                $(idKey + params.name +\" li\").each(function() {\n                    var isHover = $(this).attr(\"data-hover\"), clHover = clKey + \"li_hover\";\n                    \n                    $(this).hover(function() {\n                        var jqueryHover = $(this).siblings(\".\" + clHover);\n                        jqueryHover.removeClass(clHover).children(\".\"+ clKey +\"box\").hide();\n                        jqueryHover.children(\".\"+ clKey +\"a\").removeClass(clKey +\"a_hover\");\n                        \n                        if (isHover) {                    \n                            $(this).addClass(clHover).children(\".\"+ clKey +\"box\").show();\n                            $(this).children(\".\"+ clKey +\"a\").addClass(clKey +\"a_hover\");    \n                        }\n                        \n                    });\n                    \n                });\n                return $(idKey + params.name);\n            } \n            return jqueryMenu;\n        };\n        \n        $(this).each(function() {\n            this.oncontextmenu = function(e) {\n                //回调\n                if ($.isFunction(params.beforeShow)) {\n                    params.beforeShow.call(this);    \n                }\n                e = e || window.event;\n                //阻止冒泡\n                e.cancelBubble = true;\n                if (e.stopPropagation) {\n                    e.stopPropagation();\n                }\n                //隐藏当前上下文菜单，确保页面上一次只有一个上下文菜单\n                $.smartMenu.hide();\n                var st = D.scrollTop();\n                var jqueryMenu = funSmartMenu();\n                if (jqueryMenu) {\n                    /*\n                        2017.12.4修改：根据触发事件的位置，自适应方向弹出\n                    */\n                    if( e.clientX <= (e.view.innerWidth/2) && e.clientY <= (e.view.innerHeight/2))//左上\n                    {\n                        jqueryMenu.css({\n                            display: \"block\",\n                            left: e.clientX + params.offsetX ,\n                            top: e.clientY + st + params.offsetY ,\n                        });\n                    }\n                    if( e.clientX >= (e.view.innerWidth/2) && e.clientY <= (e.view.innerHeight/2))//右上\n                    {\n                        jqueryMenu.css({\n                            display: \"block\",\n                            left: e.clientX + params.offsetX -100,\n                            top: e.clientY + st + params.offsetY ,\n                        });\n                    }\n                    if( e.clientX <= (e.view.innerWidth/2) && e.clientY >= (e.view.innerHeight/2))//左下\n                    {\n                        jqueryMenu.css({\n                            display: \"block\",\n                            left: e.clientX + params.offsetX ,\n                            top: e.clientY + st + params.offsetY -120,\n                        });\n                    }\n                    if( e.clientX >= (e.view.innerWidth/2) && e.clientY >= (e.view.innerHeight/2))//右下\n                    {\n                        jqueryMenu.css({\n                            display: \"block\",\n                            left: e.clientX + params.offsetX -100,\n                            top: e.clientY + st + params.offsetY -120,\n                        });\n                    }\n                    D.data(\"target\", jqueryMenu);\n                    D.data(\"trigger\", this);\n                    //回调\n                    if ($.isFunction(params.afterShow)) {\n                        params.afterShow.call(this);    \n                    }\n                    return false;\n                }\n            };\n        });\n        if (!B.data(\"bind\")) {\n            B.bind(\"click\", $.smartMenu.hide).data(\"bind\", true);\n        }\n    };\n    $.extend($.smartMenu, {\n        hide: function() {\n            var target = D.data(\"target\");\n            if (target && target.css(\"display\") === \"block\") {\n                target.hide();\n            }        \n        },\n        removeevent: function (event) {\n            var target = D.data(\"target\");\n            if (target) {\n                target.remove();\n                if ($.isFunction(event)) {\n                    event.call(this);\n                }\n            }\n        },\n        remove: function() {\n            var target = D.data(\"target\");\n            if (target) {\n                target.remove();\n            }\n        }\n    });\n})(jQuery);\n```\n## 修改之后的效果：\n+ 在右下方召唤\n\n![](https://images2017.cnblogs.com/blog/1182173/201712/1182173-20171204170925201-1677560340.png)  \n+ 在左下方召唤\n\n![](https://images2017.cnblogs.com/blog/1182173/201712/1182173-20171204173302763-570358179.png)\n+ 在左上方召唤\n\n![](https://images2017.cnblogs.com/blog/1182173/201712/1182173-20171204173328951-2041581756.png)\n+ 在右上方召唤\n\n![](https://images2017.cnblogs.com/blog/1182173/201712/1182173-20171204173412997-167638017.png)  \n\n大概效果就是这样了，经过测试，菜单栏不会弹到视窗外面了。\n---  \nposted @ 2017-12-04 17:36 肖兆琦","time":1549025865844}
