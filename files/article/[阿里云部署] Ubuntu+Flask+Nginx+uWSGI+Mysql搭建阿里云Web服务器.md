{"title":"【博客园富文本 to Markdown】[阿里云部署] Ubuntu+Flask+Nginx+uWSGI+Mysql搭建阿里云Web服务器","content":"部署地址：123.56.7.181 （已失效）\n\nUbuntu+Flask+Nginx+uWSGI+Mysql搭建阿里云Web服务器\n首先，在部署之前，要知道各个技术都是用来做什么的，以及他们在Web服务器系统中的位置。\n\n参考结构图：  \n![](https://images2017.cnblogs.com/blog/1182173/201708/1182173-20170815092903209-247432213.png)\n\n自底向上分析，浏览器从用户输入域名访问网站开始，与网站进行交互操作，到最后离开网页，浏览器一直在发送请求、返回响应。\n\n当浏览器的请求到达Web服务器时，Web服务器接收 HTTP 请求并返回响应。常见的Web服务器有 Nginx，Apache，IIS等，我们在阿里云的Ubuntu环境下搭建Web服务器选择Nginx\n### 选择Nginx的理由？\nNginx是一款轻量级的Web服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器。其特点是占有内存少，并发能力强，事实上nginx的并发能力确实在同类型的网页服务器中表现较好，中国大陆使用nginx网站用户有：百度、京东、新浪、网易、腾讯、淘宝\n### 反向代理是什么？有什么用？\n客户端本来可以直接通过HTTP协议访问某网站应用服务器，在中间加上一个Nginx服务器，客户端请求Nginx，Nginx请求应用，然后将结果返回给客户端，此时Nginx就是反向代理服务器。\n作用：\n+ 安全，客户端对Web服务器的访问需要先经过反向代理服务器。这样可以防止外部程序对Web服务器的直接攻击。\n+ 负载均衡，反向代理服务器可以根据Web服务器的负载情况，动态地把HTTP请求交给不同的Web服务器来处理，前提是要有多个Web服务器。\n+ 提升Web服务器的IO性能。一个HTTP请求的数据，从客户端传输给服务器，是需要时间的，例如N秒，如果直接传给Web服务器，Web服务器就需要让一个进程阻塞N秒，来接收IO，这样会降低Web服务器的性能。如果使用反向代理服务器，先让反向代理服务器接收完整个HTTP请求，再把请求发给Web服务器，就能提升Web服务器的性能。还有一些静态文件的请求，可以直接交给反向代理来处理，不需要经过Web服务器。\n\n接着就到了WSGI：  \n+ WSGI，Python用于Web开发的通信协议；  \n+ uWSGI，充当Web服务器或中间件的程序：\n  + 如果架构Nginx+uWSGI+Flask，uWSGI是一个中间件；\n  + 如果架构是uWSGI+Flask，uWSGI是一个服务器；  \n+ uwsgi，是uWSGI程序实现的一个自有的协议；\n\n### 选择uWSGI的理由？\n\nWeb协议出现顺序：  \nCGI -> FCGI -> WSGI -> uwsgi  \nuwsgi，比FCGI和WSGI都快，主要特征是采用二进制来存储数据，之前的协议都是使用字符串，所以在存储空间和解析速度上都优于字符串型协议.\n### 总结一次网站请求响应的流程：\n浏览器：用户向我发送了一个请求，我将这个请求转达给Web服务器Nginx。  \nNginx：Hey，WSGI，我刚收到了一个请求，我需要你作些准备，然后由Flask来处理这个请求。  \nWSGI：OK，Nginx。我会设置好环境变量，然后将这个请求传递给Flask处理。   \nFlask：Thanks WSGI！给我一些时间，我将会把请求的响应返回给你。\nWSGI：Alright，那我等你。  \nFlask：Okay，我完成了，这里是请求的响应结果，请求把结果传递给Nginx。  \nWSGI：Good job！Nginx，这里是响应结果，已经按照要求给你传递回来了。  \nNginx：Cool，我收到了，我把响应结果返回给客户端。  \n浏览器：接收Nginx返回响应，加载页面，等待用户下一次发送请求  \n\n以上部分的参考资料：\n[1](http://blog.csdn.net/lihao21/article/details/52304119)\n[2](http://www.cnblogs.com/Xjng/p/aa4dd23918359c6414d54e4b972e9081.html)\n\n### 接下来该部署服务器了\n阿里云购买学生ECS服务器，Ubuntu14.04系统（自带了Python2.7）\n\n如果本机是ubuntu，服务器也是ubuntu就方便了，直接用scp命令把本地Flask程序拷贝到服务器上，scp命令:　\n\nscp -r 本地目录 用户名@IP地址 : 服务器上的目录，需要输入服务器的用户密码\n\n接下来先从阿里云进入服务器控制台\n\n+ 更新apt-get\n```\n        sudo apt-get update\n        sudo apt-get upgrade\n```\n+ 安装SSH\n```\n        sudo apt-get install ssh\n```\n阿里云提供的控制台比较简陋，我们可以在本地使用SSH命令远程连接服务器，本地的Terminal用起来更方便，ssh命令：  \n+  ssh 用户名@IP地址，需要输入服务器的用户密码\n\n### 连接成功后开始配置环境，先从MySQL开始\n\n+ 安装\n\nsudo apt-get install mysql-server\n\n+ 配置\n\n  + 数据库初始化：sudo mysql_install_db  \n  + 运行数据库Mysql安全配置向导（根据提示操作即可）\n  + sudo mysql_secure_installation\n\n然后安装pip、env\n\n+ 安装python-dev包 sudo apt-get install python-dev\n+ 安装pip   \n  sudo apt-get install python-pip\n+ 安装配置VirtualEnv  \nVirtualEnv可以管理多个开发环境，VirtualEnvWrapper使得VirtualEnv变得更好用  \n　　sudo pip install virtualenv virtualenvwrapper  \n安装完成以后，需要在环境变量中加入一些配置：  \n```\n　　echo \"export WORKON_HOME=~/Env\" >> ~/.bashrc\n　　echo \"source /usr/local/bin/virtualenvwrapper.sh\" >> ~/.bashrc\n　　source ~/.bashrc\n```\n然后就可以开始建立一个虚拟环境：  \n　　mkvirtualenv first  \n　　你会发现，提示符变成(first)user@hostname:~$,表示现在已经进入first的虚拟环境，在此环境下进行的pip等操作，只会在当前环境下生效  \n\n退出当前的虚拟环境：  \n　　deactivate  \n\n安装uWSGI、Nginx   \n```\nsudo pip install uwsgi\nsudo apt-get install nginx\n```\n配置uWSGI、Nginx：   \nuWSGI在项目目录下新建config.ini，配置参数在此填写  \nNginx在/etc/nginx/sites-available/default，配置参数在此填写  \n\n配置完毕后  \nsudo service nginx restart  \nsudo service uwsgi restart\n\n启动后终端处于监控状态，此时打开浏览器访问网站，有\n+ Nginx欢迎界面：检查配置文件，是否目录填写错误\n+ 502错误：看上去是代理服务器的问题，多数情况下一般是Flask程序的问题，服务器运行和本地运行的代码并非完全一样，注意检查启动代码\n+ 网站主页：虽然这时算是配置成功了，但仍然可能出现若干问题，比如数据库字符集/账户问题，查看服务器上uWSGI监控的日志排除错误。\n\n参考资料：\n[1](https://segmentfault.com/a/1190000007262187)\n[2](http://www.jianshu.com/p/84978157c785)\n[3](http://www.cnblogs.com/Ray-liang/p/4173923.html?utm_source=tuicool&utm_medium=referral)\n--- \nposted @ 2017-08-04 00:32 肖兆琦","time":1549010628168}
