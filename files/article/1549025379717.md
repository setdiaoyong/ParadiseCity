{"title":"【博客园富文本 to Markdown】[epub] epub.js的ePubReader函数报URI malformed错误的解决办法","content":"## 报错信息：URI malformed\n\n今天遇到了一个奇怪的问题折腾三个小时，最后发现是作者在底层使用了decodeURIComponent进行URL解码，而我在应用层使用了escape/unescape进行编码和解码，才造成了此错误。\n\n仔细读了依赖的reader.min.js源码发现：ePubReader函数接受URI并解析epub文件时，需要在URI尾部使用#对章节进行定位，因此使用了decodeURIComponent进行解码。\n\n解决方案：将构造URI的方法使用encodeURIComponent和decodeURIComponent进行编码解码传输。不能使用escape和unescape。\n\n[参考资料](https://www.cnblogs.com/jhxk/articles/1634359.html)\n\nJavaScript对文字进行编码涉及3个函数：   \n escape,encodeURI,encodeURIComponent，  \n相应3个解码函数：  \nunescape,decodeURI,decodeURIComponent\n\n+ 传递参数时需要使用encodeURIComponent，这样组合的url才不会被#等特殊字符截断。                           \n例如：<script language=\"javascript\">document.write('<a href=\"http://passport.baidu.com/?logout&aid=7&u='+encodeURIComponent (\"http://cang.baidu.com/bruce42\")+'\">退出</a>');</script>\n\n+ 进行url跳转时可以整体使用encodeURI  \n例如：Location.href=encodeURI(http://cang.baidu.com/do/s?word=百度&ct=21);\n\n+ js使用数据时可以使用escape  \n例如：搜藏中history纪录。   \nescape对0-255以外的unicode值进行编码时输出%u****格式，其它情况下escape，encodeURI，encodeURIComponent编码结果相同。\n\n最多使用的应为encodeURIComponent，它是将中文、韩文等特殊字符转换成utf-8格式的url编码，所以如果给后台传递参数需要使用encodeURIComponent时需要后台解码对utf-8支持（form中的编码方式和当前页面编码方式相同）\n\nescape不编码字符有69个：*，+，-，.，/，@，_，0-9，a-z，A-Z\n\nencodeURI不编码字符有82个：!，#，$，&，'，(，)，*，+，,，-，.，/，:，;，=，?，@，_，~，0-9，a-z，A-Z\n\nencodeURIComponent不编码字符有71个：!， '，(，)，*，-，.，_，~，0-9，a-z，A-Z\n\n---\nposted @ 2017-11-15 17:16 肖兆琦","time":1549025379717}